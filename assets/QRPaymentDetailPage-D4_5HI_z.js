import{b as h,r as a,e as j,j as e,B as f,A as w,R as p,f as N,u as b,P as y,g as v}from"./index-CJfzJY_1.js";import{L as E}from"./LoadingAnimation-Bq4ub2WY.js";import{p as g}from"./parseQueryString-D6boyO2y.js";const S=({orderData:s})=>{const r=h(),[o,t]=a.useState(!1),[n,i]=a.useState(""),{connected:m,connect:l,disconnect:c}=j({url:w.PAYMENT.ORDER.SSE_TEMP,onMessage:u=>{console.log(u),i(u.message)}});a.useEffect(()=>{n&&t(!1)},[n]);const x=()=>{l(),t(!0)},d=()=>{m&&c(),r(p.PAYMENT.QR)};return e.jsxs(e.Fragment,{children:[n&&e.jsxs("div",{className:"flex flex-col items-center p-6",children:[e.jsx("div",{className:"text-lg font-semibold text-gray-800",children:"결제가 완료되었습니다."}),e.jsx(f,{onClick:d,className:"mt-4 bg-blue-500 text-white hover:bg-blue-600 transition duration-200",children:"돌아가기"})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx(E,{}),e.jsx("p",{className:" text-lg font-semibold",children:"결제가 진행중입니다."})]}),!o&&!n&&e.jsxs(e.Fragment,{children:[e.jsx("img",{src:"/logo.png",className:"w-16",alt:"Logo"}),e.jsx("p",{className:" text-2xl font-medium",children:"결제를 하시겠습니까?"}),e.jsx("div",{role:"separator",className:"mb-8"}),e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("p",{className:"text-gray-500",children:"상점"}),e.jsx("p",{className:"overflow-hidden text-ellipsis whitespace-nowrap max-w-[70%]",children:s==null?void 0:s.merchant_name})]}),e.jsx("div",{role:"separator",className:"mb-4"}),e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("p",{className:"text-gray-500",children:"상품"}),e.jsx("p",{className:"overflow-hidden text-ellipsis whitespace-normal max-w-[70%] line-clamp-2",style:{overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical",whiteSpace:"normal",maxWidth:"70%"},children:s==null?void 0:s.order_name})]}),e.jsx("div",{role:"separator",className:"mb-4"}),e.jsxs("div",{className:"flex justify-between items-center w-full",children:[e.jsx("p",{className:"text-gray-500",children:"가격"}),e.jsxs("p",{className:"max-w-[70%] font-bold",children:[Number(s==null?void 0:s.amount).toLocaleString("ko")," KRW"]})]}),e.jsx("div",{role:"separator",className:"mb-8"}),e.jsx(f,{variant:"default",size:"extraLarge",rounded:!0,className:"w-[calc(100%-34px)] font-bold",onClick:x,children:"결제하기"}),e.jsx(f,{variant:"outline_primary",size:"extraLarge",rounded:!0,className:"w-[calc(100%-34px)] text-[#18A0FB] font-bold rounded-full mt-4",onClick:d,children:"취소하기"})]})]})},L=()=>{const s=N(),[r,o]=a.useState(s.state),[t,n]=a.useState(!0);if(a.useEffect(()=>{n(!0);const i=s.state;if(!i||typeof i!="object")throw new Error("라우터 상태가 필요하지만 제공되지 않았습니다.");o(i),n(!1)},[s]),r===null)throw new Error("location.state가 null입니다");return{state:r,isLoading:t}},P=s=>{const[r,o]=a.useState(null),[t,n]=a.useState(!0),[i,m]=a.useState(null);return a.useEffect(()=>{if(!s){m("주문정보 Token 이 없습니다."),n(!1);return}try{const c=s.split(".")[1].replace(/-/g,"+").replace(/_/g,"/"),x=decodeURIComponent(escape(window.atob(c))),d=JSON.parse(x);o(d)}catch(l){const c=l instanceof Error?l.message:String(l);m(`JWT 파싱 중 오류가 발생했습니다. ${c}`)}finally{n(!1)}},[s]),{payload:r,isLoading:t,isError:i}},T=()=>{const s=h(),{openDialog:r,closeModal:o}=b(),{state:t}=L(),n=g(location.search).token,i=g(location.search).expiredAt,m=n||(t==null?void 0:t.token),l=i||(t==null?void 0:t.expiredAt),c=a.useRef(!1);a.useEffect(()=>{if(console.log("expiredAt",l),!l)return;new Date().getTime()>Number(l)&&!c.current&&(c.current=!0,r("alert",{title:"오류",description:`만료된 QR 코드입니다.
다시 시도해 주세요.`,confirm:()=>{o(),c.current=!1,s(`${p.PAYMENT.QR}`)}}))},[l,r,o,s]);const{payload:x,isLoading:d,isError:u}=P(m);return e.jsx(y,{className:"bg-gradient-to-br from-[#3c1488] via-[#408693] to-[#1e7f84] w-full  flex justify-center items-center",children:e.jsx("div",{className:"bg-white w-[320px] h-[600px] rounded-[1rem] flex flex-col justify-center items-center p-8",children:e.jsxs(e.Fragment,{children:[x&&e.jsx(S,{orderData:x}),d&&e.jsx(v,{}),u&&e.jsxs(e.Fragment,{children:[e.jsx("div",{children:"에러가 발생했습니다"}),e.jsx("div",{children:"주문 정보를 불러오는데 실패했습니다. "}),e.jsx("div",{children:"다시 시도해 주세요."}),e.jsx(f,{className:"w-[calc(100%-32px)] h-12 text-[#18A0FB] font-bold rounded-full mt-4",isPending:d,onClick:()=>s(`${p.PAYMENT.QR}`),children:"QR 다시 시도하기"})]})]})})})};export{T as default};
